<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.smartooth.premium.mapper.OrganMapper">
	
	
	
	
	<!-- 유치원, 어린이집 정보 조회 -->
    <select id="selectSchoolInfo" parameterType="String" resultType="co.smartooth.premium.vo.OrganVO">

		SELECT 
			SCHOOL_CODE
			,SCHOOL_NAME
			,ORGAN_SIDO_NM
			,ORGAN_SIGUNGU_NM
			,ORGAN_EUPMYEONDONG_NM
			,IS_VISIBLE
			,USER_SEQ_NO
		FROM ST_SCHOOL_INFO
		WHERE 1=1
		AND SCHOOL_CODE = #{schoolCode}

    </select>





	<!-- 피측정자 증가에 따른 기관 회원 시퀀스 증가 -->
	<update id="updateSchoolUserSeqNo" parameterType="co.smartooth.premium.vo.OrganVO">
		
		UPDATE ST_SCHOOL_INFO
		SET
			USER_SEQ_NO  = #{userSeqNo}
		WHERE 1=1
		AND SCHOOL_CODE= #{schoolCode}
		
	</update>

    
    
    
    
    <!-- 유치원, 어린이집 목록 조회 -->
    <select id="selectSchoolList" parameterType="String" resultType="map">
    
		SELECT 
			@ROWNUM:=@ROWNUM+1 AS SEQ
			,SCHOOL_CODE
			,SCHOOL_NAME
			,CONCAT(ORGAN_SIDO_NM, ' ', ORGAN_SIGUNGU_NM, ' ', ORGAN_EUPMYEONDONG_NM) AS ORGAN_ADDRESS
		FROM ST_SCHOOL_INFO
		WHERE 1=1
		AND (@ROWNUM:=0)=0
		<if test="schoolName != null and schoolName != ''">
			AND SCHOOL_NAME LIKE CONCAT('%', #{schoolName}, '%')
   		</if>
   		ORDER BY SCHOOL_NAME ASC
   		
    </select>
    
    
    
    
    
    <!-- 유치원, 어린이집 소속 반 목록 조회 -->
	<select id="selectClassList" parameterType="String" resultType="hashmap">
		
		SELECT 
			SCI.SCHOOL_CODE								AS SCHOOL_CODE
			,SSI.SCHOOL_NAME								AS SCHOOL_NAME
			,SCI.CLASS_CODE								AS CLASS_CODE
			,SCI.CLASS_NAME								AS CLASS_NAME
		FROM ST_CLASS_INFO SCI
		LEFT OUTER JOIN ST_SCHOOL_INFO SSI
		ON SCI.SCHOOL_CODE = SSI.SCHOOL_CODE
		WHERE 1=1 
		AND SCI.SCHOOL_CODE = #{schoolCode}
		ORDER BY SCI.CLASS_CODE ASC
		
	</select>
    
    
    
    
    
	<!-- 유치원, 어린이집 검색 -->
    <select id="ajaxSelectSchoolList" parameterType="String" resultType="hashmap">
    
		SELECT 
			@ROWNUM:=@ROWNUM+1 AS SEQ
			,SCHOOL_CODE
			,SCHOOL_NAME
			,CONCAT(ORGAN_SIDO_NM, ' ', ORGAN_SIGUNGU_NM, ' ', ORGAN_EUPMYEONDONG_NM) AS ORGAN_ADDRESS
		FROM ST_SCHOOL_INFO
		WHERE 1=1
		AND (@ROWNUM:=0)=0
		<if test="searchType == 'SCHOOL_CODE' and searchData != null and searchData != ''">
			AND SCHOOL_CODE LIKE CONCAT('%', #{searchData}, '%')
   		</if>
		<if test="searchType == 'SCHOOL_NAME' and searchData != null and searchData != ''">
			AND SCHOOL_NAME LIKE CONCAT('%', #{searchData}, '%')
   		</if>
   		
   		ORDER BY SCHOOL_CODE ASC
   		
    </select>
    
    
    
    
    
	<!-- 유치원, 어린이집 반 목록 조회 -->
	<select id="selectDepartmentList" parameterType="String" resultType="hashmap">
		
		SELECT 
			SCI.SCHOOL_CODE								AS SCHOOL_CODE
			,SSI.SCHOOL_NAME								AS SCHOOL_NAME
			,SCI.CLASS_CODE								AS CLASS_CODE
			,SCI.CLASS_NAME								AS CLASS_NAME
		FROM ST_CLASS_INFO SCI
		LEFT OUTER JOIN ST_SCHOOL_INFO SSI
		ON SCI.SCHOOL_CODE = SSI.SCHOOL_CODE
		WHERE 1=1 
		<if test="searchType == 'SCHOOL_CODE' and searchData != null and searchData != ''">
		AND SCI.SCHOOL_CODE = #{searchData}
		</if>
		ORDER BY SSI.SCHOOL_CODE ASC, CLASS_CODE ASC
		
	</select>
    
    
    
    
    
	<!-- 유치원, 어린이집 치아 측정일 목록 조회 (기준 : 기관코드) -->
	<select id="selectOrganMeasureDtList" parameterType="String" resultType="HashMap">
		SELECT
			DATE_FORMAT(STM.MEASURE_DT, '%Y-%m-%d') AS MEASURE_DT
		FROM ST_TEETH_MEASURE STM
		LEFT OUTER JOIN ST_STUDENT_USER_DETAIL SSUD
		ON STM.USER_ID = SSUD.USER_ID
		WHERE 1=1
		AND SSUD.TEACHER_ID =
													(
														SELECT CLASS_CODE FROM ST_CLASS_INFO
														WHERE 1=1
														AND SCHOOL_CODE = #{schoolCode}
														LIMIT 1
													)
		GROUP BY DATE_FORMAT(STM.MEASURE_DT, '%Y-%m-%d')
		ORDER BY DATE_FORMAT(STM.MEASURE_DT, '%Y-%m-%d') DESC
	</select>
    
    
    
    
    
    <!-- 유치원, 어린이집 소속 반 이름 조회 -->
    <select id="selectClassName" parameterType="String" resultType="String">

		SELECT 
	   		CLASS_NAME
	   	FROM ST_STUDENT_USER_DETAIL STUD
	   	LEFT OUTER JOIN ST_CLASS_INFO SCI
	   	ON STUD.TEACHER_ID = SCI.CLASS_CODE
	   	WHERE 1=1
	   	AND STUD.USER_ID = #{userId}

    </select>
	
	
	
	

</mapper>